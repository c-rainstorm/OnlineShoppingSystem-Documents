# 数据库设计文档

<!-- vscode-markdown-toc -->
* 1. [关于此文档](#-0)
	* 1.1. [文档目的](#-1)
	* 1.2. [文档范围](#-2)
	* 1.3. [读者对象](#-3)
* 2. [数据库环境说明](#-4)
* 3. [实体间联系 / 概念设计](#-5)
* 4. [数据定义 / 逻辑设计](#-6)
	* 4.1. [用户表](#-7)
	* 4.2. [管理员表](#-8)
	* 4.3. [事务表](#-9)
	* 4.4. [店铺表](#-10)
	* 4.5. [商品表](#-11)
	* 4.6. [商品图片表](#-12)
	* 4.7. [商品属性表](#-13)
	* 4.8. [商品订单表](#-14)
	* 4.9. [订单中商品表](#-15)
	* 4.10. [收货人表](#-16)
	* 4.11. [收藏店铺表](#-17)
	* 4.12. [收藏商品表](#-18)
	* 4.13. [购物车表](#-19)
	* 4.14. [分类表](#-20)
* 5. [安全性设计](#-21)
	* 5.1. [防止用户直接操作数据库的方法](#-22)
	* 5.2. [用户帐号密码的加密方法](#-23)
	* 5.3. [角色与权限](#-24)
* 6. [优化](#-25)
	* 6.1. [触发器](#-26)
* 7.1. [数据库管理与维护说明](#-27)

<!-- /vscode-markdown-toc -->

---

##  1. <a name='-0'></a>关于此文档

###  1.1. <a name='-1'></a>文档目的

本文档的目的是设计《网上购物系统》中各项功能和非功能性需求实现时所需要的数据库，并可以此数据库为根据实现具体的数据存储。同时为详细设计人员提供设计依据，其他本项目组的开发人员也可参阅。

###  1.2. <a name='-2'></a>文档范围

本文档包含一下几个部分：

1. 文档介绍。
1. 数据库环境说明。
1. 逻辑设计。
1. ~~物理设计~~。
1. 安全性设计。
1. 优化。
1. 数据库管理与维护说明。

###  1.3. <a name='-3'></a>读者对象

《网上购物系统数据库设计报告》的阅读对象为：

- 对相关业务技术和总体方案作出决策的管理人员和质量管理人员。
- 对本《数据库设计报告》进行评审和确认的有关业务、技术人员。
- 参加详细设计，测试设计阶段工作的全体设计人员。
- 《网上购物系统》项目组，其他有权需要调用本文档的人员。

##  2. <a name='-4'></a>数据库环境说明

运行的目标操作系统为 Windows 10 + Debian 8.6。
采用的数据库系统为 Mysql community server 5.5。
设计工具为 PowerDesigner15。
数据库编码方式为 utf-8，数据库中主要字符的编码格式为 utf-8。其中一个英文字符占用 1 个字节，一个中文字符占用三个字节。

##  3. <a name='-5'></a>实体间联系 / 概念设计

![实体联系图](../images/OnlineShoppingSystem(E-R).jpg)

##  4. <a name='-6'></a>数据定义 / 逻辑设计

日期类型只精确到日，时间类型精确到秒。
+店铺编号，普通用户申请开店是填写的。

所有编号不允许修改和删除。
所有带状态标记的元祖，删除时都是假删除。

分类表允许删除元祖。

| 表名 | 英文名 | 功能说明 |
| --- | --- | --- |
| 用户表 | user | 保存用户信息 |
| 管理员表| admin | 保存管理员信息 |
| 事务表 | transaction | 记录事务信息 |
| 店铺表 | shop | 记录店铺信息 |
| 商品表 | goods | 保存商品信息 |
| 商品图片表 | goods_image | 保存商品的预览图地址 |
| 商品属性表 | goods_attribute | 记录商品的属性信息 |
| 商品订单表 | goods_order | 记录订单信息 |
| 订单中商品表 | goods_in_order | 记录订单中的商品信息 |
| 收货人表 | receiver | 记录收货信息 |
| 收藏店铺表 | favorite_shops | 记录收藏夹中的店铺信息 |
| 收藏商品表 | favorite_goods | 记录收藏夹中的商品信息 |
| 购物车表 | shopping_cart | 保存购物车信息 |
| 分类表 | category | 提供两层分类 |

###  4.1. <a name='-7'></a>用户表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 用户编号 | user_id         | 整型 | 非空 | 主键，从1开始自增 |
| 用户名   | username       | 可变字符型（25位）| 非空 | 注册/登录时填写。唯一 。字母、数字、'-'、下划线的组合 |
| 登录密码 | password        | 可变字符型（120位）| 非空 | 注册/登陆时填写。字母、数字、'-'、下划线的组合，不少于 6 个字符、不超过 20 个字符。|
| 昵称     | nickname        | 可变字符型（20位） |   | 默认为用户名 |
| 手机号   | phone           | 字符型 (11位) | 非空 | 注册/登陆时填写。唯一 |
| 头像     | avatar          | 可变字符型（50位） |   | 图片地址，默认头像为 `images/avatars/default.jpg`。当用户自主设置时，采用时间格式`yyyyMMddHHmmssSSS`(精确到毫秒)并追加随机3位(10以内)数字 + '.jpg' 形式存储于文件系统中, 并更新数据库中图片地址 |
| 性别     | sex             | 枚举类型|   | 男，女，保密三选一 |
| 出生日期 | birthday        | 日期类型 |   |   |

###  4.2. <a name='-8'></a>管理员表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 管理员编号 | admin_id  | 整型 | 非空 | 主键，登录使用 |
| 登录密码   | password  | 可变字符型（120位） | 非空 | 不少于6个不多于20个字符 |
| 管理员名称 | admin_name | 可变字符型（20位） |   | 处理事务时显示 |

###  4.3. <a name='-9'></a>事务表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 事务编号 | transaction_id     | 整型 | 非空 | 主键，从1开始自增 |
| 用户编号 | user_id            | 整型 | 非空 | 外键，提交人 |
| 管理员编号 | admin_id         | 整型 |   | 外键，处理人，提交时为空 |
| 事务类型 | transaction_type   | 枚举类型 | 非空 | 开店申请，用户投诉 |
| 事务状态 | transaction_status | 枚举类型 | 非空 | 未处理，已通过，已拒绝 |
| 内容描述 | comment            | 可变字符型（300位）| 非空 ,不超过 100 个汉字|   |
| 提交时间 | commit_time        | 时间类型 | 非空 |   |
| 完毕时间 | complete_time      | 时间类型 |   |   |
| 处理备注 | annotation         | 可变字符型（100位）|   | 管理员填写 ,不超过 100 个汉字|

###  4.4. <a name='-10'></a>店铺表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 店铺编号 | registration_id | 字符型（15位） | 非空 | 主键，即有效注册号 |
| 用户编号 | user_id         | 整型 | 非空 | 外键，绑定的用户 |
| 店铺名称 | shop_name       | 可变字符型（90位）| 非空 | 不超过 30 个汉字 |
| 店铺地址 | address         | 可变字符型（150位） | 非空 | 不超过 50 个汉字   |
| 联系方式 | phone           | 字符型（11位） | 非空 | 用户手机号 |
| 店铺描述 | shop_describe   | 可变字符型（300位） |   | 未设置则显示默认值--"暂无描述"。不超过 100 个汉字 |
| 公告     | announcement    | 可变字符型（300位） |   | 未设置则显示默认值--"暂无公告"。不超过 100 个汉字 |
| 总评分   | evaluate_sum    | 长整型 |   | 店铺总评分，初始为0 |
| 评分人数 | evaluate_number | 长整型 |   | 评价过的人数，初始为0 |

###  4.5. <a name='-11'></a>商品表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 商品编号 | goods_id              | 整型 | 非空 | 主键，从1开始自增 |
| 分类编号 | category_id           | 整型 | 非空 | 外键 |
| 店铺编号 | registration_id       | 字符型（15位） | 非空 | 外键 |
| 商品名称 | goods_name            | 可变字符型（90位） | 非空 | 不超过 30 汉字  |
| 销量     | sales                 | 整型 | 非空 | 默认为0 |
| 打折截止时间 | discount_deadline | 时间类型 |   | 默认为 2000-01-01 00:00:00  |
| 打折比例 | discount_rate         | double |   | 默认为1  |
| 状态 | is_valid        | 布尔型 | 非空 | 默认为true |
| 商品描述 | goods_describe        | 可变字符型（300位）|   |  不超过 100 汉字 |

###  4.6. <a name='-12'></a>商品图片表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 图像编号 | image_id           | 整型 | 非空 | 主键，从1开始自增 |
| 商品编号 | goods_id              | 整型 | 非空 | 外键 |
| 图像地址 | image_addr       | 字符型（50位） | 非空 | 采用时间格式`yyyyMMddHHmmssSSS`(精确到毫秒)并追加随机3位(10以内)数字 + '.jpg' 。每次获取图像时，根据图像地址排序，最多获取最近上传的 6 张 |
| 状态 | is_valid        | 布尔型 | 非空 | 默认为true |


###  4.7. <a name='-13'></a>商品属性表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 属性编号 | attribute_id       | 整型  | 非空 | 主键，从1开始自增 |
| 属性值   | attribute_value    | 可变字符型（90位）| 非空  | 不超过 30 个汉字  |
| 商品编号 | goods_id           | 整型  | 非空 | 外键 |
| 进价     | cost               | double | 非空 |   |
| 售价     | price              | double | 非空 |   |
| 库存     | inventory          | 整型 | 非空 | 默认为0 |
| 状态 | is_valid | 布尔型 | 非空 | 默认为true |

###  4.8. <a name='-14'></a>商品订单表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 订单编号 | order_id         | 长整型 | 非空 | 主键，唯一。提交订单时系统自动生成。16 位数字，从 1 开始，不够十六位使用前导 0 补足 |
| 用户编号 | user_id          | 整型 | 非空 | 外键 |
| 店铺编号 | registration_id  | 字符型（15位） |   | 外键 |
| 订单状态 | order_status     | 枚举类型 | 非空 | 待付款，待发货，待收货，待评价，已完成，已取消|
| 运单号   | tracking_number  | 字符型（12位） |   | 用户下单时为空，商家发货时必须填写运单号。12 位纯数字。|
| 支付方式 | pay_method       | 可变长字符型（16位）|   | 枚举。货到付款/在线支付 |
| 下单时间 | order_time       | 时间类型 | 非空 | 精确到秒 |
| 完成时间 | complete_time    | 时间类型 |   |   |
| 备注     | annotation       | 可变字符型（100位） |   |  不超过 30 个字符 |
| 总金额   | total            | double |   |   |
| 收货人编号 | receiver_id    | 整型 | 非空 | 收货信息 |

###  4.9. <a name='-15'></a>订单中商品表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 订单编号   | order_id      | 长整型 | 非空 | 主键 |
| 属性编号   | attribute_id  | 整型 | 非空 | 主键 |
| 商品编号   | goods_id      | 整型 | 非空 |   |
| 商品数量   | goods_num     | 整型 | 非空 |   |
| 交易时成本 | cost          | double | 非空 | 用户不可见  |
| 成交价     | actual_price  | double | 非空  |   |
| 评价内容   | comment        | 可变字符型（300位） |   |  不超过 100 个汉字 |
| 评价分值   | evaluate_score | 短整型 |   | 0~5,5个评分等级 |
| 评价时间   | evaluate_time  | 时间类型 |   |   |

###  4.10. <a name='-16'></a>收货人表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 收货人编号 | receiver_id | 整型 | 非空 | 主键，从1开始自增 |
| 用户编号   | user_id     | 整型 | 非空 | 外键 |
| 收货人姓名 | name        | 可变字符型（30位） | 非空 | 由中文、英文字母组成，不能含有其他字符。|
| 收货地址   | address     | 可变字符型（150位） | 非空 |   |
| 手机号     | phone       | 字符型（11位） | 非空 |   |
| 已使用次数 | used_times  | 整型 | 非空 | 用户不可见，默认为0 |
| 状态 | is_valid | 布尔型 | 非空 | 默认为true |

###  4.11. <a name='-17'></a>收藏店铺表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 收藏编号 | id   | 长整型 | 非空 | 主键，从1开始自增 |
| 店铺编号 | registration_id | 字符型（15位） | 非空 |  |
| 用户编号 | user_id         | 整型 | 非空 |  |
| 状态 | is_valid | 布尔型 | 非空 | 默认为true |

###  4.12. <a name='-18'></a>收藏商品表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 收藏编号 | id   | 长整型 | 非空 | 主键，从1开始自增 |
| 商品编号 | goods_id | 整型 | 非空 |  |
| 用户编号 | user_id  | 整型 | 非空 |  |
| 状态 | is_valid | 布尔型 |   | 默认为true |

###  4.13. <a name='-19'></a>购物车表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 购物车记录编号 | id   | 长整型 | 非空 | 主键，从1开始自增 |
| 用户编号 | user_id   | 整型 | 非空 |  |
| 属性编号 | attribute_id | 整型  | 非空 |  |
| 商品编号 | goods_id  | 整型 | 非空 |   |
| 商品数量 | goods_num | 整型 | 非空 | 大于等于 1， 当用户删除商品时，将 is_valid 改为 false，而不将商品数量减为 0 |
| 状态 | is_valid | 布尔型 | 非空 | 默认为true |

###  4.14. <a name='-20'></a>分类表

| 列名 | 英文名 | 数据类型（精度范围） | 空/非空 | 说明 |
| --- | --- | --- | --- | --- |
| 分类编号 | category_id | 整型 | 非空 | 主键，从1开始自增 |
| 一级分类 | level_one   | 可变字符型（30位） | 非空 | 大分类 |
| 二级分类 | level_two   | 可变字符型（30位） | 非空 | 细分 |
| 状态 | is_valid | 布尔型 | 非空 | 默认为true |

##  5. <a name='-21'></a>安全性设计

提高软件系统的安全性应当从“管理”和“设计”两方面着手。这里仅考虑数据库的安全性设计。

###  5.1. <a name='-22'></a>防止用户直接操作数据库的方法

一般用户只能用帐号登陆到网站或APP，通过网站或APP访问数据库，而没有其它途径操作数据库。

###  5.2. <a name='-23'></a>用户帐号密码的加密方法

尝试对用户帐号的密码进行加密处理，确保在任何地方都不会出现密码的明文。

###  5.3. <a name='-24'></a>角色与权限

如无特别说明，只有管理员可以查看各表的编号。

商家同时具有用户的所有权限。

<table border="1">
<tr>
 <th>角色</th>
 <th>可以访问的表与列</th>
 <th>操作权限</th>
</tr>
<tr>
 <th rowspan="4">游客</th>
 <td>商品表所有列</td>
 <td>检索</td>
</tr>
<tr>
 <td>分类表所有列</td>
 <td>检索</td>
</tr>
<tr>
 <td>商品属性表：除了进价</td>
 <td>检索</td>
</tr>
<tr>
 <td>店铺表所有列</td>
 <td>检索</td>
</tr>   <!--游客表结束-->

<tr>
 <th rowspan="13">用户</th>
 <td>商品表所有列</td>
 <td>检索</td>
</tr>
<tr>
 <td>分类表所有列</td>
 <td>检索</td>
</tr>
<tr>
 <td>店铺表所有列</td>
 <td>检索</td>
<tr>
 <td>商品订单表所有列</td>
 <td>检索 </td>
</tr>
<tr>
 <td>商品属性表：除了进价</td>
 <td>检索</td>
</tr>
<tr>
 <td>商品订单表：支付方式，收货人编号，处理备注，完成时间</td>
 <td>更新 </td>
</tr>
<tr>
 <td>购物车表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>用户表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>收货人表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>收藏商品表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>收藏店铺表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>事务表所有列</td>
 <td>检索</td>
</tr>
<tr>
 <td>事务表中的：事物类型，内容描述</td>
 <td>更新</td>
</tr>   <!--用户表结束-->

<tr>
 <th rowspan="4">商家</th>
 <td>商品表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>店铺表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>商品属性表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>商品订单表：总金额，运单号</td>
 <td>更新</td>
</tr>   <!--商家表结束-->

<tr>
 <th rowspan="13">管理员</th>
 <td>收货人表所有列</td>
 <td>检索</td>
</tr>
<tr>
 <td>收藏店铺表所有列</td>
 <td>检索</td>
</tr>
<tr>
 <td>收藏商品表所有列</td>
 <td>检索</td>
</tr>
<tr>
 <td>购物车表所有列</td>
 <td>检索</td>
</tr>
<tr>
 <td>商品订单表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>订单中商品表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>商品表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>管理员所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>事务表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>店铺表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>用户表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>商品属性表所有列</td>
 <td>更新</td>
</tr>
<tr>
 <td>分类表所有列</td>
 <td>更新</td>
</tr>   <!--管理员表结束-->
</table>

数据库用户的创建已加入 `./create_reset_db.sql` 文件中。

##  6. <a name='-25'></a>优化

###  6.1. <a name='-26'></a>触发器

1. 商家删除商品。当 `goods::is_valid` 被标记为 `false` 时，自动设置其他表中相应记录：
	- `favorite_goods::is_valid = false`
	- `goods_attribute::is_valid = false`
	- `goods_image::is_valid = false`
	- `favorite_goods::is_valid = false`
1. 商品评价。 当 `goods_in_order::evaluate_score` 更新，自动设置其他表中相应记录：
	- `shop::evaluate_sum += goods_in_order::evaluate_score`
	- `shop::evaluate_number += 1`
	- `goods_in_order::evaluate_time = now()`

##  7.1. <a name='-27'></a>数据库管理与维护说明

不提供数据库管理与维护。
