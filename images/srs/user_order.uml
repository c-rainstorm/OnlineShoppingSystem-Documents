@startuml

(*) --> "用户从购物车挑选商品\n 点击结算"

if "" then
  -->[用户已登录] "系统弹出确认订单信息页面"
else
  -->[用户未登录] "弹出即时登录/注册界面"
  --> "用户登录/注册"
  note right: 流程同正常登录/注册\n 不要忘记跳转回登录/注册前界面
  --> "系统弹出确认订单信息页面"
endif

"系统弹出确认订单信息页面" --> "用户填写收货地址等信息\n 点击确认订单并付款按钮"
--> ===B1===

partition order {
===B1=== --> "系统生成新订单\n 订单状态为 未付款" as A1
}

partition address {
===B1=== --> if "" then
  -->[用户给出新的收货地址] "系统保存新地址备下次使用\n 使用次数 = 1" as A2
else
  -->[用户使用已有收货地址] "对应收货地址使用次数 +1" as A3
endif
}

A1 --> ===B2===
A2 --> ===B2===
A3 --> ===B2===
===B2===  --> "系统弹出付款页面"

if "" then
  -->[用户付款] if "" then
    -->[商品库存满足订单要求] "减少对应商品库存"
    --> "对应商品销量 +"
    --> "减少购物车中对应商品数量"
    note right: 流程同购物车管理
    --> "更改订单状态为已付款"
    --> "提示用户订单已发起"
  else
    -->[商品库存不足] "更改订单状态为取消 2"
    --> "提示用户付款太晚\n 商品被抢"
    --> (*)
  endif
else
  -->[用户未付款\n 关闭了付款页面] "更改订单状态为取消 1"
  --> "提示用户未付款订单已取消"
  --> (*)
endif

"提示用户订单已发起" --> (*)

@enduml
